{
  "id": "e264cba0-e48e-41f9-8f66-1bf3ff07fd36",
  "title": "Leverage ADO timeline API & transform to SLDC events",
  "description": "",
  "actor": "56950d1e-d9e8-4c6f-9c70-46b093c4434d",
  "owner": "56950d1e-d9e8-4c6f-9c70-46b093c4434d",
  "ownerType": "USER",
  "isPrivate": false,
  "schemaVersion": 3,
  "trigger": {
    "schedule": {
      "isActive": false,
      "isFaulty": false,
      "trigger": {
        "type": "interval",
        "intervalMinutes": 60
      },
      "rule": null,
      "filterParameters": {
        "earliestStart": "2024-04-18",
        "earliestStartTime": "00:00"
      },
      "timezone": "Australia/Sydney",
      "inputs": {}
    }
  },
  "result": null,
  "type": "STANDARD",
  "input": {},
  "hourlyExecutionLimit": 1000,
  "guide": null,
  "tasks": {
    "pull_azo_build_detailsandpushsdlcevents": {
      "name": "pull_azo_build_detailsandpushsdlcevents",
      "input": {
        "script": "import { credentialVaultClient,CredentialsDetailsTokenResponseElement } from \"@dynatrace-sdk/client-classic-environment-v2\";\n\nvar CONFIG = {\n  organization: \"ORG\",\n  project: \"PROJECTNAME\",\n\n  adoPatCredentialId: \"CREDENTIALS_VAULT-xxx\",\n  sdlcTokenCredentialId: \"CREDENTIALS_VAULT-xxx\",\n\n  lookbackMinutes: 60,\n  pageSize: 200,\n\n  batchSize: 50,\n\n  // Tenant endpoint\n  sdlcIngestUrl: \"https://xxx.apps.dynatrace.com/platform/ingest/v1/events.sdlc\",\n\n  // Option 3: include stages + jobs + tasks\n  includeStageEvents: true,\n  includeJobEvents: true,\n  includeTaskEvents: true,\n\n  includePhaseEvents: false,\n\n  logRequestUrls: false,\n  logSampleEvents: 3,\n  logBatchBodies: false\n};\n\nfunction nowIso() {\n  return new Date().toISOString();\n}\n\nfunction logInfo(message) {\n  console.log(nowIso() + \" [INFO] \" + message);\n}\n\nfunction logWarn(message) {\n  console.log(nowIso() + \" [WARN] \" + message);\n}\n\nfunction logError(message) {\n  console.log(nowIso() + \" [ERROR] \" + message);\n}\n\nfunction isoMinutesAgo(minutes) {\n  return new Date(Date.now() - minutes * 60 * 1000).toISOString();\n}\n\nfunction msToNs(ms) {\n  return Math.round(ms * 1000000);\n}\n\nfunction isoToNs(iso) {\n  return msToNs(Date.parse(iso));\n}\n\nfunction toStringSafe(value) {\n  if (value === null || value === undefined) {\n    return \"\";\n  }\n  return String(value);\n}\n\nfunction base64(text) {\n  return btoa(text);\n}\n\nfunction chunk(list, size) {\n  var out = [];\n  var i = 0;\n  while (i < list.length) {\n    out.push(list.slice(i, i + size));\n    i += size;\n  }\n  return out;\n}\n\nasync function getVaultToken(credentialId) {\n  var details = await credentialVaultClient.getCredentialsDetails({ id: credentialId });\n  var tokenDetails = details;\n\n  if (!tokenDetails || !tokenDetails.token) {\n    throw new Error(\"Credential Vault token not found for id=\" + credentialId);\n  }\n\n  return tokenDetails.token;\n}\n\nasync function httpJson(url, options) {\n  var response = await fetch(url, options);\n  var text = await response.text();\n\n  if (!response.ok) {\n    throw new Error(\"HTTP \" + String(response.status) + \": \" + text);\n  }\n\n  if (text.trim().length === 0) {\n    return {};\n  }\n\n  return JSON.parse(text);\n}\n\nasync function fetchCompletedBuilds(org, project, pat, minTimeIso, pageSize) {\n  var url =\n    \"https://dev.azure.com/\" +\n    encodeURIComponent(org) +\n    \"/\" +\n    encodeURIComponent(project) +\n    \"/_apis/build/builds\" +\n    \"?api-version=7.1\" +\n    \"&statusFilter=completed\" +\n    \"&minTime=\" + encodeURIComponent(minTimeIso) +\n    \"&queryOrder=finishTimeDescending\" +\n    \"&$top=\" + String(pageSize);\n\n  if (CONFIG.logRequestUrls) {\n    logInfo(\"Azure DevOps builds URL: \" + url);\n  }\n\n  var auth = \"Basic \" + base64(\":\" + pat);\n\n  var data = await httpJson(url, {\n    method: \"GET\",\n    headers: {\n      \"Accept\": \"application/json\",\n      \"Authorization\": auth\n    }\n  });\n\n  if (!data || !Array.isArray(data.value)) {\n    return [];\n  }\n\n  return data.value;\n}\n\nasync function fetchBuildTimelineRecords(org, project, pat, buildId) {\n  var url =\n    \"https://dev.azure.com/\" +\n    encodeURIComponent(org) +\n    \"/\" +\n    encodeURIComponent(project) +\n    \"/_apis/build/builds/\" +\n    encodeURIComponent(buildId) +\n    \"/timeline\" +\n    \"?api-version=7.1\";\n\n  if (CONFIG.logRequestUrls) {\n    logInfo(\"Azure DevOps timeline URL: \" + url);\n  }\n\n  var auth = \"Basic \" + base64(\":\" + pat);\n\n  var data = await httpJson(url, {\n    method: \"GET\",\n    headers: {\n      \"Accept\": \"application/json\",\n      \"Authorization\": auth\n    }\n  });\n\n  if (!data || !Array.isArray(data.records)) {\n    return [];\n  }\n\n  return data.records;\n}\n\nfunction lowerType(record) {\n  return toStringSafe(record.type).toLowerCase();\n}\n\nfunction isStage(record) {\n  return lowerType(record) === \"stage\";\n}\n\nfunction isPhase(record) {\n  return lowerType(record) === \"phase\";\n}\n\nfunction isJob(record) {\n  return lowerType(record) === \"job\";\n}\n\nfunction isTask(record) {\n  return lowerType(record) === \"task\";\n}\n\nfunction mapBuildToSdlcEvent(org, project, build) {\n  var startNs = build.startTime ? isoToNs(build.startTime) : msToNs(Date.now());\n  var endNs = build.finishTime ? isoToNs(build.finishTime) : msToNs(Date.now());\n  var eventId = \"ado:\" + org + \":\" + project + \":build:\" + toStringSafe(build.id);\n\n  return {\n    \"event.provider\": \"azure-devops\",\n    \"event.type\": \"build\",\n    \"event.status\": \"finished\",\n    \"event.category\": \"task\",\n    \"event.id\": eventId,\n\n    \"start_time\": startNs,\n    \"end_time\": endNs,\n\n    \"cicd.pipeline.id\": toStringSafe(build.definition ? build.definition.id : \"\"),\n    \"cicd.pipeline.run.id\": toStringSafe(build.id),\n\n    \"task.id\": toStringSafe(build.id),\n    \"task.name\": \"Azure DevOps build \" + toStringSafe(build.buildNumber),\n\n    \"vcs.branch.name\": toStringSafe(build.sourceBranch),\n    \"vcs.commit.id\": toStringSafe(build.sourceVersion),\n\n    \"ado.organization\": org,\n    \"ado.project\": project,\n\n    \"build.number\": toStringSafe(build.buildNumber),\n    \"build.status\": toStringSafe(build.status),\n    \"build.result\": toStringSafe(build.result),\n    \"build.webUrl\": toStringSafe(build._links && build._links.web ? build._links.web.href : \"\")\n  };\n}\n\nfunction mapTimelineRecordToSdlcEvent(org, project, build, record) {\n  // Map stage/job/task timeline record into an SDLC task event.\n\n  var startNs;\n  var endNs;\n\n  if (record.startTime) {\n    startNs = isoToNs(record.startTime);\n  } else {\n    startNs = msToNs(Date.now());\n  }\n\n  if (record.finishTime) {\n    endNs = isoToNs(record.finishTime);\n  } else {\n    endNs = startNs;\n  }\n\n  var recordId = toStringSafe(record.id);\n  var recordType = toStringSafe(record.type);\n  var parentId = toStringSafe(record.parentId);\n  var eventId = \"ado:\" + org + \":\" + project + \":build:\" + toStringSafe(build.id) + \":record:\" + recordId;\n\n  return {\n    \"event.provider\": \"azure-devops\",\n    \"event.type\": recordType,\n    \"event.status\": \"completed\",\n    \"event.id\": eventId,\n\n    \"start_time\": startNs,\n    \"end_time\": endNs,\n\n    \"cicd.pipeline.id\": toStringSafe(build.definition ? build.definition.id : \"\"),\n    \"cicd.pipeline.run.id\": toStringSafe(build.id),\n\n    \"task.id\": recordId,\n    \"task.name\": toStringSafe(record.name),\n    \"task.type\": recordType,\n    \"task.parent_id\": parentId,\n\n    \"task.state\": toStringSafe(record.state),\n    \"task.result\": toStringSafe(record.result),\n\n    \"vcs.branch.name\": toStringSafe(build.sourceBranch),\n    \"vcs.commit.id\": toStringSafe(build.sourceVersion),\n    \"vcs.repository.name\": toStringSafe(build.repository ? build.repository.name : \"\"),\n    \"vcs.repository.id\": toStringSafe(build.repository ? build.repository.id : \"\"),\n    \"vcs.repository.type\": toStringSafe(build.repository ? build.repository.type : \"\"),\n    \n    \"ado.organization\": org,\n    \"ado.project\": project,\n\n    \"build.id\": toStringSafe(build.id),\n    \"build.number\": toStringSafe(build.buildNumber),\n    \"build.webUrl\": toStringSafe(build._links && build._links.web ? build._links.web.href : \"\")\n  };\n}\n\nasync function ingestSdlcBatch(sdlcToken, batch, batchIndex, totalBatches) {\n  var url = CONFIG.sdlcIngestUrl;\n\n  if (CONFIG.logBatchBodies) {\n    logInfo(\"Batch payload: \" + JSON.stringify(batch));\n  }\n\n  var response = await fetch(url, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"Authorization\": \"Api-Token \" + sdlcToken\n    },\n    body: JSON.stringify(batch)\n  });\n\n  var responseText = await response.text();\n\n  logInfo(\"SDLC ingest batch \" + String(batchIndex) + \"/\" + String(totalBatches) + \" -> status=\" + String(response.status) + \" size=\" + String(batch.length));\n\n  if (!response.ok) {\n    throw new Error(\"SDLC ingest failed: HTTP \" + String(response.status) + \": \" + responseText);\n  }\n}\n\nexport default async function () {\n  logInfo(\"Workflow started (Stages + Jobs + Tasks enabled)\");\n\n  var minTimeIso = isoMinutesAgo(CONFIG.lookbackMinutes);\n  logInfo(\"Fetching builds since \" + minTimeIso);\n\n  var adoPat = await getVaultToken(CONFIG.adoPatCredentialId);\n  var sdlcToken = await getVaultToken(CONFIG.sdlcTokenCredentialId);\n\n  var builds = await fetchCompletedBuilds(\n    CONFIG.organization,\n    CONFIG.project,\n    adoPat,\n    minTimeIso,\n    CONFIG.pageSize\n  );\n\n  logInfo(\"Builds returned: \" + String(builds.length));\n\n  var events = [];\n  var sampleCount = 0;\n\n  var i;\n  for (i = 0; i < builds.length; i++) {\n    var build = builds[i];\n\n    // Always ingest build-level SDLC event\n    events.push(mapBuildToSdlcEvent(CONFIG.organization, CONFIG.project, build));\n\n    // Pull timeline to ingest stages + jobs + tasks\n    var records = await fetchBuildTimelineRecords(CONFIG.organization, CONFIG.project, adoPat, build.id);\n\n    var stageCount = 0;\n    var phaseCount = 0;\n    var jobCount = 0;\n    var taskCount = 0;\n\n    var r;\n    for (r = 0; r < records.length; r++) {\n      var rec = records[r];\n\n      if (CONFIG.includeStageEvents && isStage(rec)) {\n        events.push(mapTimelineRecordToSdlcEvent(CONFIG.organization, CONFIG.project, build, rec));\n        stageCount += 1;\n      } else if (CONFIG.includePhaseEvents && isPhase(rec)) {\n        events.push(mapTimelineRecordToSdlcEvent(CONFIG.organization, CONFIG.project, build, rec));\n        phaseCount += 1;\n      } else if (CONFIG.includeJobEvents && isJob(rec)) {\n        events.push(mapTimelineRecordToSdlcEvent(CONFIG.organization, CONFIG.project, build, rec));\n        jobCount += 1;\n      } else if (CONFIG.includeTaskEvents && isTask(rec)) {\n        events.push(mapTimelineRecordToSdlcEvent(CONFIG.organization, CONFIG.project, build, rec));\n        taskCount += 1;\n      }\n    }\n\n    logInfo(\n      \"BuildId=\" + toStringSafe(build.id) +\n      \" stages=\" + String(stageCount) +\n      \" phases=\" + String(phaseCount) +\n      \" jobs=\" + String(jobCount) +\n      \" tasks=\" + String(taskCount)\n    );\n\n    while (sampleCount < CONFIG.logSampleEvents && sampleCount < events.length) {\n      logInfo(\"Sample event[\" + String(sampleCount) + \"]: \" + JSON.stringify(events[sampleCount]));\n      sampleCount += 1;\n    }\n  }\n\n  logInfo(\"Total SDLC events prepared: \" + String(events.length));\n\n  var batches = chunk(events, CONFIG.batchSize);\n  logInfo(\"Batches to ingest: \" + String(batches.length));\n\n  var ingested = 0;\n  var failedBatches = 0;\n\n  for (i = 0; i < batches.length; i++) {\n    try {\n      await ingestSdlcBatch(sdlcToken, batches[i], i + 1, batches.length);\n      ingested += batches[i].length;\n    } catch (e) {\n      failedBatches += 1;\n      logError(\"Batch \" + String(i + 1) + \" failed: \" + String(e.message || e));\n    }\n  }\n\n  logInfo(\"Workflow finished. eventsIngested=\" + String(ingested) + \" failedBatches=\" + String(failedBatches));\n\n  return {\n    lookbackMinutes: CONFIG.lookbackMinutes,\n    minTimeIso: minTimeIso,\n    buildsFound: builds.length,\n    eventsPrepared: events.length,\n    eventsIngested: ingested,\n    failedBatches: failedBatches\n  };\n}"
      },
      "action": "dynatrace.automations:run-javascript",
      "position": {
        "x": 0,
        "y": 1
      },
      "conditions": {
        "states": {}
      },
      "description": "Run custom JavaScript code.",
      "predecessors": []
    }
  }
}
